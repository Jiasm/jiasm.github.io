<!DOCTYPE html>
<html>
<head>
  <title>index</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="resource/css/reset.css" />
  <link rel="stylesheet" type="text/css" href="resource/css/base.css" />
  <link rel="stylesheet" type="text/css" href="resource/css/default.css" />
  <link rel="Shortcut Icon" href="resource/icon.ico">
</head>
<body>
  <header>
    <h1><a href="?">贾顺名</a></h1>
    <h2>Web初级熟练工</h2>
  </header>
  <main id="main">
    <header><h1>全部文章</h1></header>
    <ul id="article-list"></ul>
  </main>
  <footer>
    &copy;贾顺名
    <div id="go2top" title="灰上去"></div>
  </footer>
  <script type="text/javascript" src="js/jquery.js"></script>
  <script type="text/javascript" src="js/require.js"></script>
  <script type="text/javascript">
    /*引入多说*/
    var duoshuoQuery = {short_name:"jiasm"};
    (function (){
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
       || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    /*引入多说 end*/
    //改装一下多说- -
    function initDUOSHUO () {
      document.body.scrollTop = "0px";
      DUOSHUO.init();
      var countList = document.getElementsByClassName("ds-thread-count"),counts;
      for (var len = countList.length - 1, counts = countList[len]; len > 0; len--, counts = countList[len])
        counts.innerHTML = counts.innerHTML||"暂无评论";
    }
    onload = function () {
      location.search?change():init();
    }
    function init () {
      require(['feed/index'],function  (_data) {
        var datas = _data.data;
        var $panel = document.createDocumentFragment();
        var $article = createElement("li");
        var $title = createElement("p");
        var $postTitle = createElement("a");
        var $dateTitle = createElement("time");
        var $comments = createElement("p");
        $article.className = "article";
        $title.className = "title";
        $postTitle.className = "post-title";
        $dateTitle.className = "date-title";
        for (var len = datas.length - 1; len >= 0; len--) {
          var data = datas[len];
          $article = $article.cloneNode();
          $title = $title.cloneNode();
          $postTitle = $postTitle.cloneNode();
          $dateTitle = $dateTitle.cloneNode();
          $comments = $comments.cloneNode();
          $postTitle.innerHTML = data.title;
          $postTitle.href = "?page=" + data.id;
          $postTitle.title = data.title;
          $postTitle.id = data.id;
          $dateTitle.innerHTML = data.postDate;
          $postTitle.appendChild($dateTitle);
          $comments.innerHTML = '<span class="ds-thread-count" data-thread-key="' + data.id + '" data-count-type="comments"></span>';
          $title.appendChild($postTitle);
          $article.appendChild($title);
          $article.appendChild($comments);
          $panel.appendChild($article);
        }
        document.getElementById("article-list").appendChild($panel);
        initDUOSHUO();
      });
    }
    function change () {
      var key = location.search.substring(1);
      var search = generate(key);
      require(["feed/" + search.page], function (_data) {
        build(_data, document.getElementById("main"))
      })
    }
    function generate (key) {
      var kvs = key.split("&"), kv, len, obj = {};
      for (var len = kvs.length - 1, kv = kvs[len].split("="); len >= 0; kv = kvs[len--].split("="))
        obj[kv[0]] = kv[1];
      return obj;
    }
    function build (data, container) {
      var $panel = document.createDocumentFragment();
      var $article = createElement("article");
      var $header =createElement("header");
      var $postTitle = createElement("h1");
      var $postDate = createElement("time");
      var $content = createElement("section");
      $postTitle.innerHTML = data.title;
      $postDate.innerHTML = data.postDate;
      $header.appendChild($postTitle);
      $header.appendChild($postDate);
      $article.appendChild($header);
      $content.innerHTML = data.content;
      $article.appendChild($content);
      $panel.appendChild($article);
      //添加多说评论框
      var duoshuoBox = [];
      duoshuoBox.push('<div class="ds-thread" data-thread-key="');
      duoshuoBox.push(data.id);
      duoshuoBox.push('" data-title="');
      duoshuoBox.push(data.title);
      duoshuoBox.push('" data-url="jiasm.github.io"></div>');
      
      container.innerHTML = $article.outerHTML + duoshuoBox.join("");
      initDUOSHUO();
    }
    function createElement(tag) {
      return document.createElement(tag);
    }

    $(window).scroll(function(){
      $(window).scrollTop()>100?$("#go2top").fadeIn(1000): $("#go2top").fadeOut(1000);
    });

    $("#go2top").click(function(){
      $('body,html').animate({scrollTop:0},1000);
    });
  </script>
</body>
</html>