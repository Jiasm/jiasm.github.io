<!DOCTYPE html>
<html>
<head>
  <title>index</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="resource/css/reset.css" />
  <link rel="stylesheet" type="text/css" href="resource/css/base.css" />
  <link rel="stylesheet" type="text/css" href="resource/css/default.css" />
  <link rel="Shortcut Icon" href="resource/icon.ico">
</head>
<body>
  <header>
    <h1>贾顺名</h1>
    <h2>Web初级熟练工</h2>
  </header>
  <nav class="for-back">
    <button id="retreat" title="后退"></button><!--
    --><button id="forward" title="前进"></button>
  </nav>
  <main id="main">
    <header><h1>全部文章</h1></header>
    <ul id="article-list"></ul>
  </main>
  <footer>
    &copy;贾顺名
  </footer>
  <script type="text/javascript" src="js/require.js"></script>
  <script type="text/javascript">
    /*引入多说*/
    var duoshuoQuery = {short_name:"jiasm"};
    (function (){
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
       || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    /*引入多说 end*/
    //改装一下多说- -
    function initDUOSHUO () {
      document.body.scrollTop = "0px";
      DUOSHUO.init();
      var countList = document.getElementsByClassName("ds-thread-count"),counts;
      for (var len = countList.length - 1, counts = countList[len]; len > 0; len--, counts = countList[len])
        counts.innerHTML = counts.innerHTML||"暂无评论";
    }
    var $history;
    onload = function () {
      init();
      document.body.onclick = navigation;
      $history = new History("retreat", "forward");
    }
    function init () {
      require(['feed/index'],function  (_data) {
        var datas = _data.data;
        var $panel = document.createDocumentFragment();
        var $article = createElement("li");
        var $title = createElement("p");
        var $postTitle = createElement("a");
        var $dateTitle = createElement("time");
        var $comments = createElement("p");
        $article.className = "article";
        $title.className = "title";
        $postTitle.className = "post-title";
        $dateTitle.className = "date-title";
        for (var len = datas.length - 1; len >= 0; len--) {
          var data = datas[len];
          $article = $article.cloneNode();
          $title = $title.cloneNode();
          $postTitle = $postTitle.cloneNode();
          $dateTitle = $dateTitle.cloneNode();
          $comments = $comments.cloneNode();
          $postTitle.innerHTML = data.title;
          $postTitle.title = data.title;
          //$postTitle.href = "#" + data.id;
          $postTitle.id = data.id;
          $dateTitle.innerHTML = data.postDate;
          $postTitle.appendChild($dateTitle);
          $comments.innerHTML = '<span class="ds-thread-count" data-thread-key="' + data.id + '" data-count-type="comments"></span>';
          $title.appendChild($postTitle);
          $article.appendChild($title);
          $article.appendChild($comments);
          $panel.appendChild($article);
        }
        document.getElementById("article-list").appendChild($panel);
        $history.push(document.body.cloneNode(true));
        initDUOSHUO();
      });
    }
    function build (data, container) {
      var $panel = document.createDocumentFragment();
      var $article = createElement("article");
      var $header =createElement("header");
      var $postTitle = createElement("h1");
      var $postDate = createElement("time");
      var $content = createElement("section");
      $postTitle.innerHTML = data.title;
      $postDate.innerHTML = data.postDate;
      $header.appendChild($postTitle);
      $header.appendChild($postDate);
      $article.appendChild($header);
      $content.innerHTML = data.content;
      $article.appendChild($content);
      $panel.appendChild($article);
      //添加多说评论框
      var duoshuoBox = [];
      duoshuoBox.push('<div class="ds-thread" data-thread-key="');
      duoshuoBox.push(data.id);
      duoshuoBox.push('" data-title="');
      duoshuoBox.push(data.title);
      duoshuoBox.push('" data-url="jiasm.github.io"></div>');
      
      container.innerHTML = $article.outerHTML + duoshuoBox.join("");
      $history.push(document.body.cloneNode(true));
      initDUOSHUO();
    }
    function createElement(tag) {
      return document.createElement(tag);
    }
    function navigation (event) {
      var target = (event || window.event).target;
      if (target.localName === "a" || target.localName === "time") {
        require(["feed/" + (target.id || target.parentNode.id)], function (_data) {
          build(_data, document.getElementById("main"))
        })
      }
    }
    function History (_retreat, _forward, _max) {
      var _history = [], _max = _max, cursor = -1;
      this.push = function (tag) {
        if (_max & _history.length >= _max) _history.shift();
        cursor++;
        if (cursor != _history.length) {
          _history = _history.slice(0, cursor)
        }
        _history.push(tag.innerHTML);
        document.getElementById(_retreat).disabled = cursor <= 0;
        document.getElementById(_forward).disabled = cursor >= _history.length - 1;
      }
      this.refresh = function () {
        _history = [];
        cursor = -1;
      }
      var rebind = function () {
        document.body.innerHTML = _history[cursor];
        document.body.onclick = navigation;
        $retreat = document.getElementById(_retreat);
        $forward = document.getElementById(_forward);
        $retreat.disabled = cursor <= 0;
        $forward.disabled = cursor >= _history.length - 1;
        $retreat.onclick = retreat;
        $forward.onclick = forward;
        initDUOSHUO();
      }
      var retreat = function () {
        if (cursor <= 0) return;
        cursor--;
        rebind();
      }
      var forward = function () {
        if (cursor >= _history.length) return;
        cursor++;
        rebind();
      }
      var $retreat = document.getElementById(_retreat);
      var $forward = document.getElementById(_forward);
      $retreat.disabled = true;
      $forward.disabled = true;
      $retreat.onclick = retreat;
      $forward.onclick = forward;
    }
  </script>
</body>
</html>