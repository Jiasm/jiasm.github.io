<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  
  
  
  <title>koa源码阅读[1]-koa与koa-compose - Jarvis&#39;s Blog</title>
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/prism-coy.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head>


  <body class="fixed">
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">Jarvis&#39;s Blog</a>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link menu-item-home">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link menu-item-about">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/contact" class="menu-item-link menu-item-contact">Contact</a>
        </li>
      
        <li class="menu-item">
          <a href="/links" class="menu-item-link menu-item-friends">Friends</a>
        </li>
      
        <li class="menu-item">
          <a href="https://github.com/jiasm" class="menu-item-link menu-item-github">Github</a>
        </li>
      
    </ul>
  </nav>
</header>

        <main class="main">
          
  <input type="checkbox" id="toggle-toc" class="toggle-toc-right" />
  <div class="toc-toggle toc-toggle-right">
    <label for="toggle-toc">
      <i class="fa fa-list-ol"></i>
    </label>
    <div class="toc-wrap toc-wrap-right">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#koa基本结构"><span class="toc-number">1.</span> <span class="toc-text">koa基本结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拿一个完整的流程来解释"><span class="toc-number">2.</span> <span class="toc-text">拿一个完整的流程来解释</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建服务"><span class="toc-number">2.1.</span> <span class="toc-text">创建服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用koa-compose合并中间件"><span class="toc-number">2.2.</span> <span class="toc-text">使用koa-compose合并中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接收请求，处理返回值"><span class="toc-number">2.3.</span> <span class="toc-text">接收请求，处理返回值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#洋葱模型执行完成后的一些操作"><span class="toc-number">2.3.1.</span> <span class="toc-text">洋葱模型执行完成后的一些操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异常处理"><span class="toc-number">2.3.2.</span> <span class="toc-text">异常处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redirect的注意事项"><span class="toc-number">2.3.3.</span> <span class="toc-text">redirect的注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小记"><span class="toc-number">3.</span> <span class="toc-text">小记</span></a></li></ol>
    </div>
  </div>
  <label class="mask" for="toggle-toc"></label>

<div id="post-content">
  <h1>koa源码阅读[1]-koa与koa-compose</h1>
  <p>接上次挖的坑，对<code>koa2.x</code>相关的源码进行分析 <a href="/2018/07/22/koa源码阅读-0/">第一篇</a>。<br>不得不说，<code>koa</code>是一个很轻量、很优雅的http框架，尤其是在2.x以后移除了<code>co</code>的引入，使其代码变得更为清晰。  </p>
<p><code>express</code>和<code>koa</code>同为一批人进行开发，与<code>express</code>相比，<code>koa</code>显得非常的迷你。<br>因为<code>express</code>是一个大而全的<code>http</code>框架，内置了类似<code>router</code>之类的中间件进行处理。<br>而在<code>koa</code>中，则将类似功能的中间件全部摘了出来，早期<code>koa</code>里边是内置了<code>koa-compose</code>的，而现在也是将其分了出来。<br><code>koa</code>只保留一个简单的中间件的整合，<code>http</code>请求的处理，作为一个功能性的中间件框架来存在，自身仅有少量的逻辑。<br><code>koa-compose</code>则是作为整合中间件最为关键的一个工具、洋葱模型的具体实现，所以要将两者放在一起来看。</p>
<a id="more"></a>
<h2 id="koa基本结构"><a href="#koa基本结构" class="headerlink" title="koa基本结构"></a>koa基本结构</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token keyword">.</span>
├── application.js
├── request.js
├── response.js
└── context.js
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于<code>koa</code>整个框架的实现，也只是简单的拆分为了四个文件。  </p>
<p>就象在上一篇笔记中模拟的那样，创建了一个对象用来注册中间件，监听<code>http</code>服务，这个就是<code>application.js</code>在做的事情。<br>而框架的意义呢，就是在框架内，我们要按照框架的规矩来做事情，同样的，框架也会提供给我们一些更易用的方式来让我们完成需求。<br>针对<code>http.createServer</code>回调的两个参数<code>request</code>和<code>response</code>进行的一次封装，简化一些常用的操作。<br>例如我们对<code>Header</code>的一些操作，在原生<code>http</code>模块中可能要这样写：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 获取Content-Type</span>
request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 设置Content-Type</span>
response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>
response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">,</span> <span class="token string">'18'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// 或者，忽略前边的statusCode，设置多个Header</span>
response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
  <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'18'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而在<code>koa</code>中可以这样处理：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 获取Content-Type</span>
context<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 设置Content-Type</span>
context<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
  <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'18'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简化了一些针对<code>request</code>与<code>response</code>的操作，将这些封装在了<code>request.js</code>和<code>response.js</code>文件中。<br>但同时这会带来一个使用上的困扰，这样封装以后其实获取或者设置<code>header</code>变得层级更深，需要通过<code>context</code>找到<code>request</code>、<code>response</code>，然后才能进行操作。<br>所以，<code>koa</code>使用了<a href="https://github.com/tj/node-delegates" target="_blank" rel="noopener">node-delegates</a>来进一步简化这些步骤，将<code>request.get</code>、<code>response.set</code>通通代理到<code>context</code>上。<br>也就是说，代理后的操作是这样子的：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">context<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 设置Content-Type</span>
context<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
  <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'18'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样就变得很清晰了，获取<code>Header</code>，设置<code>Header</code>，<em>再也不会担心写成<code>request.setHeader</code>了</em>，一气呵成，通过<code>context.js</code>来整合<code>request.js</code>与<code>response.js</code>的行为。<br>同时<code>context.js</code>也会提供一些其他的工具函数，例如<code>Cookie</code>之类的操作。</p>
<p>由<code>application</code>引入<code>context</code>，<code>context</code>中又整合了<code>request</code>和<code>response</code>的功能，四个文件的作用已经很清晰了：  </p>
<table>
<thead>
<tr>
<th style="text-align:left">file</th>
<th style="text-align:left">desc</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">applicaiton</td>
<td style="text-align:left">中间件的管理、<code>http.createServer</code>的回调处理，生成<code>Context</code>作为本次请求的参数，并调用中间件</td>
</tr>
<tr>
<td style="text-align:left">request</td>
<td style="text-align:left">针对<code>http.createServer -&gt; request</code>功能上的封装</td>
</tr>
<tr>
<td style="text-align:left">response</td>
<td style="text-align:left">针对<code>http.createServer -&gt; response</code>功能上的封装</td>
</tr>
<tr>
<td style="text-align:left">context</td>
<td style="text-align:left">整合<code>request</code>与<code>response</code>的部分功能，并提供一些额外的功能</td>
</tr>
</tbody>
</table>
<p><em>而在代码结构上，只有<code>application</code>对外的<code>koa</code>是采用的<code>Class</code>的方式，其他三个文件均是抛出一个普通的<code>Object</code>。</em>  </p>
<h2 id="拿一个完整的流程来解释"><a href="#拿一个完整的流程来解释" class="headerlink" title="拿一个完整的流程来解释"></a>拿一个完整的流程来解释</h2><h3 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h3><p>首先，我们需要创建一个<code>http</code>服务，在<code>koa2.x</code>中创建服务与<code>koa1.x</code>稍微有些区别，要求使用实例化的方式来进行创建：  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而在实例化的过程中，其实<code>koa</code>只做了有限的事情，创建了几个实例属性。<br>将引入的<code>context</code>、<code>request</code>以及<code>response</code>通过<code>Object.create</code>拷贝的方式放到实例中。  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 最关键的一个实例属性</span>

<span class="token comment" spellcheck="true">// 用于在收到请求后创建上下文使用</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在实例化完成后，我们就要进行注册中间件来实现我们的业务逻辑了，上边也提到了，<code>koa</code>仅用作一个中间件的整合以及请求的监听。<br>所以不会像<code>express</code>那样提供<code>router.get</code>、<code>router.post</code>之类的操作，仅仅存在一个比较接近<code>http.createServer</code>的<code>use()</code>。<br>接下来的步骤就是注册中间件并监听一个端口号启动服务：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8000</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'never output'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Server run as http://127.0.0.1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在翻看<code>application.js</code>的源码时，可以看到，暴露给外部的方法，常用的基本上就是<code>use</code>和<code>listen</code>。<br>一个用来加载中间件，另一个用来监听端口并启动服务。</p>
<p>而这两个函数实际上并没有过多的逻辑，在<code>use</code>中仅仅是判断了传入的参数是否为一个<code>function</code>，以及在2.x版本针对<code>Generator</code>函数的一些特殊处理，将其转换为了<code>Promise</code>形式的函数，并将其<code>push</code>到构造函数中创建的<code>middleware</code>数组中。<br>这个是从<code>1.x</code>过渡到<code>2.x</code>的一个工具，在<code>3.x</code>版本将直接移除<code>Generator</code>的支持。<br>其实在<code>koa-convert</code>内部也是引用了<code>co</code>和<code>koa-compose</code>来进行转化，所以也就不再赘述。  </p>
<p>而在<code>listen</code>中做的事情就更简单了，只是简单的调用<code>http.createServer</code>来创建服务，并监听对应的端口之类的操作。<br>有一个细节在于，<code>createServer</code>中传入的是<code>koa</code>实例的另一个方法调用后的返回值<code>callback</code>，这个方法才是真正的回调处理，<code>listen</code>只是<code>http</code>模块的一个快捷方式。<br>这个是为了一些用<code>socket.io</code>、<code>https</code>或者一些其他的<code>http</code>模块来进行使用的。<br>也就意味着，只要是可以提供与<code>http</code>模块一致的行为，<code>koa</code>都可以很方便的接入。  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'listen'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="使用koa-compose合并中间件"><a href="#使用koa-compose合并中间件" class="headerlink" title="使用koa-compose合并中间件"></a>使用koa-compose合并中间件</h3><p>所以我们就来看看<code>callback</code>的实现：  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onerror<span class="token punctuation">)</span>

  <span class="token keyword">const</span> handleRequest <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> handleRequest
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在函数内部的第一步，就是要处理中间件，将一个数组中的中间件转换为我们想要的洋葱模型格式的。<br>这里就用到了比较核心的<a href="https://github.com/koajs/compose" target="_blank" rel="noopener">koa-compose</a>  </p>
<p>其实它的功能上与<code>co</code>类似，只不过把<code>co</code>处理<code>Generator</code>函数那部分逻辑全部去掉了，本身<code>co</code>的代码也就是一两百行，所以精简后的<code>koa-compose</code>代码仅有48行。  </p>
<p>我们知道，<code>async</code>函数实际上剥开它的语法糖以后是长这个样子的：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> func <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">123</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ==></span>

<span class="token keyword">function</span> func <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// or</span>
<span class="token keyword">function</span> func <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以拿上述<code>use</code>的代码举例，实际上<code>koa-compose</code>拿到的是这样的参数：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token punctuation">[</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World'</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'never output'</span><span class="token punctuation">)</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>就像在第四个函数中输出表示的那样，第四个中间件不会被执行，因为第三个中间件并没有调用<code>next</code>，所以实现类似这样的一个洋葱模型是很有意思的一件事情。<br>首先抛开不变的<code>ctx</code>不谈，洋葱模型的实现核心在于<code>next</code>的处理。<br>因为<code>next</code>是你进入下一层中间件的钥匙，只有手动触发以后才会进入下一层中间件。<br>然后我们还需要保证<code>next</code>要在中间件执行完毕后进行<code>resolve</code>，返回到上一层中间件：  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// last called middleware #</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> dispatch <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'next() called multiple times'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    index <span class="token operator">=</span> i
    <span class="token keyword">let</span> fn <span class="token operator">=</span> middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> middleware<span class="token punctuation">.</span>length<span class="token punctuation">)</span> fn <span class="token operator">=</span> next
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dispatch<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以明确了这两点以后，上边的代码就会变得很清晰：</p>
<ol>
<li>next用来进入下一个中间件</li>
<li>next在当前中间件执行完成后会触发回调通知上一个中间件，而完成的前提是内部的中间件已经执行完成(<code>resolved</code>)</li>
</ol>
<p>可以看到在调用<code>koa-compose</code>以后实际上会返回一个自执行函数。<br>在执行函数的开头部分，判断当前中间件的下标来防止在一个中间件中多次调用<code>next</code>。<br>因为如果多次调用<code>next</code>，就会导致下一个中间件的多次执行，这样就破坏了洋葱模型。  </p>
<p>其次就是<code>compose</code>实际上提供了一个在洋葱模型全部执行完毕后的回调，一个可选的参数，实际上作用与调用<code>compose</code>后边的<code>then</code>处理没有太大区别。  </p>
<p>以及上边提到的，<code>next</code>是进入下一个中间件的钥匙，可以在这一个柯里化函数的应用上看出来：  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dispatch<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将自身绑定了<code>index</code>参数后传入本次中间件，作为调用函数的第二个参数，也就是<code>next</code>，效果就像调用了<code>dispatch(1)</code>，这样就是一个洋葱模型的实现。<br>而<code>fn</code>的调用如果是一个<code>async function</code>，那么外层的<code>Promise.resolve</code>会等到内部的<code>async</code>执行<code>resolve</code>以后才会触发<code>resolve</code>，例如这样：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 500ms以后才会触发 console.log</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>P.S. 一个从<code>koa1.x</code>切换到<code>koa2.x</code>的暗坑，<code>co</code>会对数组进行特殊处理，使用<code>Promise.all</code>进行包装，但是<code>koa2.x</code>没有这样的操作。<br>所以如果在中间件中要针对一个数组进行异步操作，一定要手动添加<code>Promise.all</code>，或者说等草案中的<code>await*</code>。  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// koa1.x</span>
<span class="token keyword">yield</span> <span class="token punctuation">[</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>              <span class="token comment" spellcheck="true">// [1, 2]</span>

<span class="token comment" spellcheck="true">// koa2.x</span>
<span class="token keyword">await</span> <span class="token punctuation">[</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>              <span class="token comment" spellcheck="true">// [&lt;Promise>, &lt;Promise>]</span>

<span class="token comment" spellcheck="true">// ==></span>
<span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [1, 2]</span>
<span class="token keyword">await</span><span class="token operator">*</span> <span class="token punctuation">[</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>             <span class="token comment" spellcheck="true">// [1, 2]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接收请求，处理返回值"><a href="#接收请求，处理返回值" class="headerlink" title="接收请求，处理返回值"></a>接收请求，处理返回值</h3><p>经过上边的代码，一个<code>koa</code>服务已经算是运行起来了，接下来就是访问看效果了。<br>在接收到一个请求后，<code>koa</code>会拿之前提到的<code>context</code>与<code>request</code>、<code>response</code>来创建本次请求所使用的上下文。<br>在<code>koa1.x</code>中，上下文是绑定在<code>this</code>上的，而在<code>koa2.x</code>是作为第一个参数传入进来的。<br>个人猜测可能是因为<code>Generator</code>不能使用箭头函数，而<code>async</code>函数可以使用箭头函数导致的吧:) <em>纯属个人YY</em>  </p>
<p>总之，我们通过上边提到的三个模块创建了一个请求所需的上下文，基本上是一通儿赋值，代码就不贴了，没有太多逻辑，就是有一个小细节比较有意思：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">request<span class="token punctuation">.</span>response <span class="token operator">=</span> response
response<span class="token punctuation">.</span>request <span class="token operator">=</span> request
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>让两者之间产生了一个引用关系，既可以通过<code>request</code>获取到<code>response</code>，也可以通过<code>response</code>获取到<code>request</code>。<br>而且这是一个递归的引用，类似这样的操作：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

obj<span class="token punctuation">.</span>obj <span class="token operator">=</span> obj

obj<span class="token punctuation">.</span>obj<span class="token punctuation">.</span>obj<span class="token punctuation">.</span>obj <span class="token operator">===</span> obj <span class="token comment" spellcheck="true">// true</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时如上文提到的，在<code>context</code>创建的过程中，将一大批的<code>request</code>和<code>response</code>的属性、方法代理到了自身，有兴趣的可以自己翻看源码（看着有点晕）：<a href="https://github.com/koajs/koa/blob/master/lib/context.js#L190" target="_blank" rel="noopener">koa.js | context.js</a><br>这个<a href="https://github.com/tj/node-delegates/blob/master/index.js" target="_blank" rel="noopener">delegate</a>的实现也算是比较简单，通过取出原始的属性，然后存一个引用，在自身的属性被触发时调用对应的引用，类似一个民间版的<code>Proxy</code>吧，期待后续能够使用<code>Proxy</code>代替它。  </p>
<p>然后我们会将生成好的<code>context</code>作为参数传入<code>koa-compose</code>生成的洋葱中去。<br>因为无论何种情况，洋葱肯定会返回结果的（出错与否），所以我们还需要在最后有一个<code>finished</code>的处理，做一些类似将<code>ctx.body</code>转换为数据进行输出之类的操作。  </p>
<p><code>koa</code>使用了大量的<code>get</code>、<code>set</code>访问器来实现功能，例如最常用的<code>ctx.body = &#39;XXX&#39;</code>，它是来自<code>response</code>的<code>set body</code>。<br>这应该是<code>request</code>、<code>response</code>中逻辑最复杂的一个方法了。<br>里边要处理很多东西，例如在<code>body</code>内容为空时帮助你修改请求的<code>status code</code>为204，并移除无用的<code>headers</code>。<br>以及如果没有手动指定<code>status code</code>，会默认指定为<code>200</code>。<br>甚至还会根据当前传入的参数来判断<code>content-type</code>应该是<code>html</code>还是普通的<code>text</code>：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// string</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'string'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>setType<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token regex">/^\s*&lt;/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'html'</span> <span class="token punctuation">:</span> <span class="token string">'text'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以及还包含针对流(<code>Stream</code>)的特殊处理，例如如果要用<code>koa</code>实现静态资源下载的功能，也是可以直接调用<code>ctx.body</code>进行赋值的，所有的东西都已经在<code>response.js</code>中帮你处理好了：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// stream</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'function'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> val<span class="token punctuation">.</span>pipe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> destroy<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">ensureErrorHandler</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> err <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// overwriting</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> original <span class="token operator">&amp;&amp;</span> original <span class="token operator">!=</span> val<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>setType<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'bin'</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 可以理解为是这样的代码</span>
<span class="token keyword">let</span> stream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'package.json'</span><span class="token punctuation">)</span>
ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> stream

<span class="token comment" spellcheck="true">// set body中的处理</span>
<span class="token function">onFinish</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">destory</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

stream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 使response接收流是在洋葱模型完全执行完以后再进行的</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>onFinish用来监听流是否结束、destory用来关闭流</em>  </p>
<p>其余的访问器基本上就是一些常见操作的封装，例如针对<code>querystring</code>的封装。<br>在使用原生<code>http</code>模块的情况下，处理URL中的参数，是需要自己引入额外的包进行处理的，最常见的是<code>querystring</code>。<br><code>koa</code>也是在内部引入的该模块。<br>所以对外抛出的<code>query</code>大致是这个样子的：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">get</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span>query
  <span class="token keyword">return</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// use</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query <span class="token comment" spellcheck="true">// 因为 get query也被代理到了context上，所以可以直接引用</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>parse为parseurl库，用来从request中提出query参数</em></p>
<p>亦或者针对<code>cookies</code>的封装，也是内置了最流行的<code>cookies</code>。<br>在第一次触发<code>get cookies</code>时才去实例化<code>Cookie</code>对象，将这些繁琐的操作挡在用户看不到的地方：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">get</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">[</span>COOKIES<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>COOKIES<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookies</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      keys<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>keys<span class="token punctuation">,</span>
      secure<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>secure
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>COOKIES<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">set</span> <span class="token function">cookies</span><span class="token punctuation">(</span>_cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span>COOKIES<span class="token punctuation">]</span> <span class="token operator">=</span> _cookies
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以在<code>koa</code>中使用<code>Cookie</code>就像这样就可以了：  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'uid'</span><span class="token punctuation">)</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'Niko'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 如果不想用cookies模块，完全可以自己赋值为自己想用的cookie</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>cookies <span class="token operator">=</span> CustomeCookie

<span class="token keyword">this</span><span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'uid'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是因为在<code>get cookies</code>里边有判断，如果没有一个可用的Cookie实例，才会默认去实例化。</p>
<h4 id="洋葱模型执行完成后的一些操作"><a href="#洋葱模型执行完成后的一些操作" class="headerlink" title="洋葱模型执行完成后的一些操作"></a>洋葱模型执行完成后的一些操作</h4><p><code>koa</code>的一个请求流程是这样的，先执行洋葱里边的所有中间件，在执行完成以后，还会有一个回调函数。<br>该回调用来根据中间件执行过程中所做的事情来决定返回给客户端什么数据。<br>拿到<code>ctx.body</code>、<code>ctx.status</code>这些参数进行处理。<br>包括前边提到的流(<code>Stream</code>)的处理都在这里：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token keyword">instanceof</span> <span class="token class-name">Stream</span><span class="token punctuation">)</span> <span class="token keyword">return</span> body<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 等到这里结束后才会调用我们上边`set body`中对应的`onFinish`的处理</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同时上边还有一个特殊的处理，如果为false则不做任何处理，直接返回：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>writable<span class="token punctuation">)</span> <span class="token keyword">return</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其实这个也是<code>response</code>提供的一个访问器，这里边用来判断当前请求是否已经调用过<code>end</code>给客户端返回了数据，如果已经触发了<code>response.end()</code>以后，则<code>response.finished</code>会被置为<code>true</code>，也就是说，本次请求已经结束了，同时访问器中还处理了一个<code>bug</code>，请求已经返回结果了，但是依然没有关闭套接字：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">get</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// can't write any more after response finished</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">.</span>finished<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

  <span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">.</span>socket
  <span class="token comment" spellcheck="true">// There are already pending outgoing res, but still writable</span>
  <span class="token comment" spellcheck="true">// https://github.com/nodejs/node/blob/v4.4.7/lib/_http_server.js#L486</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socket<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token keyword">return</span> socket<span class="token punctuation">.</span>writable
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里就有一个<code>koa</code>与<code>express</code>对比的劣势了，因为<code>koa</code>采用的是一个洋葱模型，对于返回值，如果是使用<code>ctx.body = &#39;XXX&#39;</code>来进行赋值，这会导致最终调用<code>response.end</code>时在洋葱全部执行完成后再进行的，也就是上边所描述的回调中，而<code>express</code>就是在中间件中就可以自由控制何时返回数据：  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// express.js</span>
router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// 在发送数据后做一些其他处理</span>
  <span class="token function">appendLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// koa.js</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello world'</span>

  <span class="token comment" spellcheck="true">// 然而依然发生在发送数据之前</span>
  <span class="token function">appendLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不过好在还是可以通过直接调用原生的<code>response</code>对象来进行发送数据的，当我们手动调用了<code>response.end</code>以后(<code>response.finished === true</code>)，就意味着最终的回调会直接跳过，不做任何处理。  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// 在发送数据后做一些其他处理</span>
  <span class="token function">appendLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><p>koa的整个请求，实际上还是一个<code>Promise</code>，所以在洋葱模型后边的监听不仅仅有<code>resolve</code>，对<code>reject</code>也同样是有处理的。<br>期间任何一环出bug都会导致后续的中间件以及前边等待回调的中间件终止，直接跳转到最近的一个异常处理模块。<br>所以，如果有类似接口耗时统计的中间件，一定要记得在<code>try-catch</code>中执行<code>next</code>的操作：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'error'</span> <span class="token comment" spellcheck="true">// 因为内部的中间件并没有catch 捕获异常，所以抛出到了这里</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> endTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 抛出异常，但是不影响这里的正常输出</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">></span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>P.S. 如果异常被捕获，则会继续执行后续的<code>response</code>：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// curl 127.0.0.1 </span>
<span class="token comment" spellcheck="true">// > hello</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果自己的中间件没有捕获异常，就会走到默认的异常处理模块中。<br>在默认的异常模块中，基本上是针对statusCode的一些处理，以及一些默认的错误显示：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> code <span class="token operator">=</span> statuses<span class="token punctuation">[</span>err<span class="token punctuation">.</span>status<span class="token punctuation">]</span>
<span class="token keyword">const</span> msg <span class="token operator">=</span> err<span class="token punctuation">.</span>expose <span class="token operator">?</span> err<span class="token punctuation">.</span>message <span class="token punctuation">:</span> code
<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> err<span class="token punctuation">.</span>status
<span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>statuses是一个第三方模块，包括各种http code的信息： <a href="https://github.com/jshttp/statuses" target="_blank" rel="noopener">statuses</a></em><br>建议在最外层的中间件都自己做异常处理，因为默认的错误提示有点儿太难看了（纯文本），自己处理跳转到异常处理页面会好一些，以及避免一些接口因为默认的异常信息导致解析失败。</p>
<h4 id="redirect的注意事项"><a href="#redirect的注意事项" class="headerlink" title="redirect的注意事项"></a>redirect的注意事项</h4><p>在原生<code>http</code>模块中进行<code>302</code>的操作（俗称重定向），需要这么做：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">'Location'</span><span class="token punctuation">:</span> <span class="token string">'redirect.html'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// or</span>
response<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">302</span>
response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token string">'redirect.html'</span><span class="token punctuation">)</span>
response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而在<code>koa</code>中也有<code>redirect</code>的封装，可以通过直接调用<code>redirect</code>函数来完成重定向，但是需要注意的是，调用完<code>redirect</code>之后并没有直接触发<code>response.end()</code>，它仅仅是添加了一个<code>statusCode</code>及<code>Location</code>而已：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token function">redirect</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> alt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// location</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'back'</span> <span class="token operator">==</span> url<span class="token punctuation">)</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'Referrer'</span><span class="token punctuation">)</span> <span class="token operator">||</span> alt <span class="token operator">||</span> <span class="token string">'/'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// status</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>statuses<span class="token punctuation">.</span>redirect<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">302</span>

  <span class="token comment" spellcheck="true">// html</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">accepts</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    url <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/html charset=utf-8'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token string">`Redirecting to &lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/a>.`</span></span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// text</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/plain charset=utf-8'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token string">`Redirecting to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.`</span></span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>后续的代码还会继续执行，所以建议在<code>redirect</code>之后手动结束当前的请求，也就是直接<code>return</code>，不然很有可能后续的<code>status</code>、<code>body</code>赋值很可能会导致一些诡异的问题。</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'https://baidu.com'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// 建议直接return</span>

  <span class="token comment" spellcheck="true">// 后续的代码还在执行</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello world'</span>
  ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span> <span class="token comment" spellcheck="true">// statusCode的改变导致redirect失效 </span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="小记"><a href="#小记" class="headerlink" title="小记"></a>小记</h2><p><code>koa</code>是一个很好玩的框架，在阅读源码的过程中，其实也发现了一些小问题：</p>
<ol>
<li>多人合作维护一份代码，确实能够看出各人都有不同的编码风格，例如<code>typeof val !== &#39;string&#39;</code>和<code>&#39;number&#39; == typeof code</code>，很显然的两种风格。2333</li>
<li>delegate的调用方式在属性特别多的时候并不是很好看，一大长串的链式调用，如果换成循环会更好看一下</li>
</ol>
<p>但是，<code>koa</code>依然是一个很棒的框架，很适合阅读源码来进行学习，这些都是一些小细节，无伤大雅。  </p>
<p>总结一下<code>koa</code>与<code>koa-compose</code>的作用：</p>
<ul>
<li><code>koa</code> 注册中间件、注册<code>http</code>服务、生成请求上下文调用中间件、处理中间件对上下文对象的操作、返回数据结束请求</li>
<li><code>koa-compose</code> 将数组中的中间件集合转换为串行调用，并提供钥匙(<code>next</code>)用来跳转下一个中间件，以及监听<code>next</code>获取内部中间件执行结束的通知</li>
</ul>

</div>

<section class="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
<script>
  var disqus_shortname = 'jiashunming';
  
  var disqus_url = 'http://jiasm.github.io/2018/07/29/koa源码阅读-1-koa与koa-compose/';
  
  var disqus_config = function () {
    this.page.url = location.href
    this.page.identifier = 'b0c0fa80-92f5-11e8-90cf-cf954482d09f'
    this.page.title = document.querySelector('h1').innerText
  };
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.setAttribute('data-timestamp', +new Date());
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script>
  // I'm not sure your browser supports `es6`
  window.addEventListener('load', function () {
    [].concat(Array.from(document.querySelectorAll('code')), Array.from(document.querySelectorAll('pre'))).filter(function (item) {return item.className.indexOf('language') >= 0}).forEach(function (tag) { tag.classList.add('line-numbers') })
    Prism.highlightAll()

    let scrollY = window.scrollY
    let headersList = Array.from(document.querySelector('#post-content').querySelectorAll('h1,h2,h3,h4,h5,h6')).map(function (item) {
      let rect = item.getBoundingClientRect()
      let anchorTag = document.querySelector(`a.toc-link[href="#${item.id}"]`)

      if (!anchorTag) return
      return {
        top: scrollY + rect.top - rect.height,
        tag: item,
        anchorTag: anchorTag
      }
    }).filter(function (item) { return item })

    window.addEventListener('scroll', debounce(scrollHandler, 200))
    scrollHandler()

    function scrollHandler () {
      let scrollY = window.scrollY
      let minInfo = null

      for (let item of headersList) {
        if (!minInfo) {
          minInfo = item
          continue
        }

        if ((scrollY - item.top) >= 0 && (scrollY - minInfo.top) > (scrollY - item.top)) {
          minInfo = item
        }
      }

      if (minInfo) {
        headersList.forEach(function (item) {
          item.anchorTag && item.anchorTag.classList.remove('selected')
        })
        minInfo.anchorTag.classList.add('selected')
      }
    }

    function debounce (func, delay) {
      let debounceIdentify = 0
      return function () {
        debounceIdentify && clearTimeout(debounceIdentify)
        debounceIdentify = setTimeout(function () {
          debounceIdentify = 0
          func.apply(this, arguments)
        }, delay)
      }
    }
  })
</script>

        </main>
        <a href="#" class="goto-top">
          <i class="fa fa-chevron-up"></i>
        </a>
    </div>
    <footer class="footer">
  <div class="footer-content">
    <div class="footer-info" class="inner">
      <p class="copyright">&copy; 2023 ShunMing Jia<br></p>
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      theme by <a href="https://github.com/Jiasm/hexo-theme-sheet" target="_blank">Sheet</a>
    </div>
    <ul class="contact-info">
      
        <a class="contact-link" href="https://github.com/jiasm" target="_blank"><i class="fa fa-github"></i></a>
      
      
        <a class="contact-link" href="https://weibo.com/jarvis1996" target="_blank"><i class="fa fa-weibo"></i></a>
      
      
        <a class="contact-link" href="https://twitter.com/jiashm" target="_blank"><i class="fa fa-twitter"></i></a>
      
      
        <a class="contact-link" href="https://www.facebook.com/jiashunming" target="_blank"><i class="fa fa-facebook"></i></a>
      
      
        <a class="contact-link" href="mailto:jiashunming@outlook.com" target="_blank"><i class="fa fa-envelope"></i></a>
      
    </ul>
  </div>
</footer>

  <!-- 使用 DISQUS js 代码 -->
  <script id="dsq-count-scr" src="//jiashunming.disqus.com/count.js" async="async"></script>



      <script>
      function footerHandler () {
        if (!window.screen || !document.body) return
        var hasComments = document.querySelector('.comments')
        if ((window.screen.availHeight - (hasComments ? 350 : 0)) > document.body.clientHeight) {
          document.body.classList.add('fixed')
        } else {
          document.body.classList.remove('fixed')
        }
      }
      footerHandler()
      window.addEventListener('resize', footerHandler)
    </script>
  </body>
  <script>
    var pathname = new URL(location.href).pathname.replace(/\/$/, '')

    switch (pathname) {
      case '/about':
        document.querySelector('.menu-item-about').classList.add('active')
        break
      case '/contact':
        document.querySelector('.menu-item-contact').classList.add('active')
        break
      case '/links':
        document.querySelector('.menu-item-friends').classList.add('active')
        break
      default:
        document.querySelector('.menu-item-home').classList.add('active')
    }
  </script>
  
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f1f7cb8bfb6de7f6a6277fee35703d98";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    

</html>