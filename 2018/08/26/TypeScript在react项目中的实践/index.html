<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  
  
  
  <title>TypeScript在react项目中的实践 - Jarvis&#39;s Blog</title>
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/prism-coy.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head>


  <body class="fixed">
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">Jarvis&#39;s Blog</a>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link menu-item-home">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link menu-item-about">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/contact" class="menu-item-link menu-item-contact">Contact</a>
        </li>
      
        <li class="menu-item">
          <a href="/links" class="menu-item-link menu-item-friends">Friends</a>
        </li>
      
        <li class="menu-item">
          <a href="https://github.com/jiasm" class="menu-item-link menu-item-github">Github</a>
        </li>
      
    </ul>
  </nav>
</header>

        <main class="main">
          
  <input type="checkbox" id="toggle-toc" class="toggle-toc-right" />
  <div class="toc-toggle toc-toggle-right">
    <label for="toggle-toc">
      <i class="fa fa-list-ol"></i>
    </label>
    <div class="toc-wrap toc-wrap-right">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目结构"><span class="toc-number">1.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前后端复用代码的一个尝试"><span class="toc-number">2.</span> <span class="toc-text">前后端复用代码的一个尝试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境的搭建"><span class="toc-number">3.</span> <span class="toc-text">环境的搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#webpack的配置"><span class="toc-number">3.1.</span> <span class="toc-text">webpack的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TypeScript相关的配置"><span class="toc-number">3.2.</span> <span class="toc-text">TypeScript相关的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ESLint的配置"><span class="toc-number">3.3.</span> <span class="toc-text">ESLint的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node层的修改"><span class="toc-number">3.4.</span> <span class="toc-text">node层的修改</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#深坑，注意"><span class="toc-number">3.4.1.</span> <span class="toc-text">深坑，注意</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">4.</span> <span class="toc-text">小结</span></a></li></ol>
    </div>
  </div>
  <label class="mask" for="toggle-toc"></label>

<div id="post-content">
  <h1>TypeScript在react项目中的实践</h1>
  <p>前段时间有写过一个<a href="/2018/07/21/TypeScript在node项目中的实践">TypeScript在node项目中的实践</a>。<br>在里边有解释了为什么要使用<code>TS</code>，以及在<code>Node</code>中的一个项目结构是怎样的。<br>但是那仅仅是一个纯接口项目，碰巧赶上近期的另一个项目重构也由我来主持，经过上次的实践以后，尝到了<code>TS</code>所带来的甜头，毫不犹豫的选择用<code>TS</code>+<code>React</code>来重构这个项目。<br>这次的重构不仅包括<code>Node</code>的重构（之前是<code>Express</code>的项目），同时还包括前端的重构（之前是由<code>jQuery</code>驱动的多页应用）。  </p>
<a id="more"></a>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p>因为目前项目是没有做前后分离的打算的（一个内部工具平台类的项目），所以大致结构就是基于上次<code>Node</code>项目的结构，在其之上添加了一些<code>FrontEnd</code>的目录结构：</p>
<pre class="line-numbers language-diff"><code class="language-diff">  .
  ├── README.md
  ├── copy-static-assets.ts
  ├── nodemon.json
  ├── package.json
<span class="token inserted">+ ├── client-dist</span>
<span class="token inserted">+ │   ├── bundle.js</span>
<span class="token inserted">+ │   ├── bundle.js.map</span>
<span class="token inserted">+ │   ├── logo.png</span>
<span class="token inserted">+ │   └── vendors.dll.js</span>
  ├── dist
  ├── src
  │   ├── config
  │   ├── controllers
  │   ├── entity
  │   ├── models
  │   ├── middleware
  │   ├── public
  │   ├── app.ts
  │   ├── server.ts
  │   ├── types
<span class="token inserted">+ │   ├── common</span>
  │   └── utils
<span class="token inserted">+ ├── client-src</span>
<span class="token inserted">+ │   ├── components</span>
<span class="token inserted">+ │   │   └── Header.tsx</span>
<span class="token inserted">+ │   ├── conf</span>
<span class="token inserted">+ │   │   └── host.ts</span>
<span class="token inserted">+ │   ├── dist</span>
<span class="token inserted">+ │   ├── utils</span>
<span class="token inserted">+ │   ├── index.ejs</span>
<span class="token inserted">+ │   ├── index.tsx</span>
<span class="token inserted">+ │   ├── webpack</span>
<span class="token inserted">+ │   ├── package.json</span>
<span class="token inserted">+ │   └── tsconfig.json</span>
<span class="token inserted">+ ├── views</span>
<span class="token inserted">+ │   └── index.ejs</span>
  ├── tsconfig.json
  └── tslint.json
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中标绿（也可能是一个<code>+</code>号显示）的文件为本次新增的。<br>其中<code>client-dist</code>与<code>views</code>都是通过<code>webpack</code>生成的，实际的源码文件都在<code>client-src</code>下。<em>就这个结构拆分前后分离其实没有什么成本</em><br>在下边分了大概这样的一些文件夹：</p>
<table>
<thead>
<tr>
<th style="text-align:center">dir/file</th>
<th style="text-align:left">desc</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>index.ejs</code></td>
<td style="text-align:left">项目的入口<code>html</code>文件，采用<code>ejs</code>作为渲染引擎</td>
</tr>
<tr>
<td style="text-align:center"><code>index.tsx</code></td>
<td style="text-align:left">项目的入口<code>js</code>文件，后缀使用<code>tsx</code>，原因有二：<br>1. 我们会使用<code>ts</code>进行<code>React</code>程序的开发 <br>2. <code>.tsx</code>文件在vs code上的<code>icon</code>比较好看 :p</td>
</tr>
<tr>
<td style="text-align:center"><code>tsconfig.json</code></td>
<td style="text-align:left">是用于<code>tsc</code>编译执行的一些配置文件</td>
</tr>
<tr>
<td style="text-align:center"><code>components</code></td>
<td style="text-align:left">组件存放的目录</td>
</tr>
<tr>
<td style="text-align:center"><code>config</code></td>
<td style="text-align:left">各种配置项存放的位置，类似请求接口的<code>host</code>或者各种状态的<code>map</code>映射之类的（可以理解为枚举对象们都在这里）</td>
</tr>
<tr>
<td style="text-align:center"><code>utils</code></td>
<td style="text-align:left">一些公共函数存放的位置，各种可复用的代码都应该放在这里</td>
</tr>
<tr>
<td style="text-align:center"><code>dist</code></td>
<td style="text-align:left">各种静态资源的存放位置，图片之类文件</td>
</tr>
<tr>
<td style="text-align:center"><code>webpack</code></td>
<td style="text-align:left">里边存放了各种环境的<code>webpack</code>脚本命令以及<code>dll</code>的生成</td>
</tr>
</tbody>
</table>
<h2 id="前后端复用代码的一个尝试"><a href="#前后端复用代码的一个尝试" class="headerlink" title="前后端复用代码的一个尝试"></a>前后端复用代码的一个尝试</h2><p>实际上边还漏掉了一个新增的文件夹，我们在<code>src</code>目录下新增了一个<code>common</code>目录，这个目录是存放一些公共的函数和公共的<code>config</code>，不同于<code>utils</code>或者<code>config</code>的是，这里的代码是前后端共享的，所以这里边的函数一定要是完全的不包含任何环境依赖，不包含任何业务逻辑的。  </p>
<p>类似的数字千分位，日期格式化，抑或是服务监听的端口号，这些不包含任何逻辑，也对环境没有强依赖的代码，我们都可以放在这里。<br>这也是没有做前后分离带来的一个小甜头吧，前后可以共享一部分代码。  </p>
<p>要实现这样的配置，基于上述项目需要修改如下几处：</p>
<ol>
<li><code>src</code>下的<code>utils</code>和<code>config</code>部分代码迁移到<code>common</code>文件夹下，主要是用于区分是否可前后通用</li>
<li>为了将对之前<code>node</code>结构方面的影响降至最低，我们需要在<code>common</code>文件夹下新增一个<code>index.ts</code>索引文件，并在<code>utils/index.ts</code>下引用它，这样对于<code>node</code>方面使用来讲，并不需要关心这个文件是来自<code>utils</code>还是<code>common</code> </li>
</ol>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// src/common/utils/comma.ts</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>num<span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token operator">=</span><span class="token operator">></span> <span class="token function">String</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\B(?=(\d{3})+$)/g</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// src/common/utils/index.ts</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> comma <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./comma'</span>

<span class="token comment" spellcheck="true">// src/utils.index.ts</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'../common/utils'</span>

<span class="token comment" spellcheck="true">// src/app.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> comma <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span> <span class="token comment" spellcheck="true">// 并不需要关心是来自common还是来自utils</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">comma</span><span class="token punctuation">(</span><span class="token number">1234567</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 1,234,567</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li>然后是配置<code>webpack</code>的<code>alias</code>属性，用于<code>webpack</code>能够正确的找到其路径</li>
</ol>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// client-src/webpack/base.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>
       <span class="token string">'@Common'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../src/common'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>同时我们还需要配置<code>tsconfig.json</code>用于<code>vs code</code>可以找到对应的目录，不然会在编辑器中提示<code>can&#39;t find module XXX</code></li>
</ol>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// client-src/tsconfig.json</span>
<span class="token punctuation">{</span>
  <span class="token string">"compilerOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"paths"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 用于引入某个`module`</span>
      <span class="token string">"@Common/*"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"../src/common/*"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li>最后在<code>client-src/utils/index.ts</code>写上类似<code>server</code>端的处理就可以了</li>
</ol>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// client-src/utils/index.ts</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'@Common/utils'</span>

<span class="token comment" spellcheck="true">// client-src/index.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> comma <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">comma</span><span class="token punctuation">(</span><span class="token number">1234567</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 1,234,567</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="环境的搭建"><a href="#环境的搭建" class="headerlink" title="环境的搭建"></a>环境的搭建</h2><p><em>如果使用<code>vs code</code>进行开发，而且使用了<code>ESLint</code>的话，需要修改<code>TS</code>语法支持的后缀，添加<code>typescriptreact</code>的一些处理，这样才会自动修复一些<code>ESLint</code>的规则：</em>  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token string">"eslint.validate"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
  <span class="token string">"javascript"</span><span class="token punctuation">,</span>
  <span class="token string">"javascriptreact"</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string">"language"</span><span class="token punctuation">:</span> <span class="token string">"typescript"</span><span class="token punctuation">,</span>
    <span class="token string">"autoFix"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string">"language"</span><span class="token punctuation">:</span> <span class="token string">"typescriptreact"</span><span class="token punctuation">,</span>
    <span class="token string">"autoFix"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="webpack的配置"><a href="#webpack的配置" class="headerlink" title="webpack的配置"></a>webpack的配置</h3><p>因为在前端使用了<code>React</code>，按照目前的主流，<code>webpack</code>肯定是必不可少的。<br>并没有选择成熟的<code>cra</code>(<a href="https://www.npmjs.com/package/create-react-app" target="_blank" rel="noopener">create-react-app</a>)来进行环境搭建，原因有下：  </p>
<ol>
<li><code>webpack</code>更新到4以后并没有尝试过，想自己耍一耍</li>
<li>结合着<code>TS</code>以及公司内部的东西，会有一些自定义配置情况的出现，担心二次开发太繁琐</li>
</ol>
<p>但是其实也没有太多的配置，本次重构选用的UI框架为Google Material的实现：<a href="https://material-ui.com/" target="_blank" rel="noopener">material-ui</a><br>而他们采用的是<a href="http://cssinjs.org/" target="_blank" rel="noopener">jss</a> 来进行样式的编写，所以也不会涉及到之前惯用的<code>scss</code>的那一套<code>loader</code>了。  </p>
<p><code>webpack</code>分了大概如下几个文件：</p>
<table>
<thead>
<tr>
<th style="text-align:center">file</th>
<th style="text-align:left">desc</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>common.js</code></td>
<td style="text-align:left">公共的<code>webpack</code>配置，类似<code>env</code>之类的选项</td>
</tr>
<tr>
<td style="text-align:center"><code>dll.js</code></td>
<td style="text-align:left">用于将一些不会修改的第三方库进行提前打包，加快开发时编译效率</td>
</tr>
<tr>
<td style="text-align:center"><code>base.js</code></td>
<td style="text-align:left">可以理解为是<code>webpack</code>的基础配置文件，通用的<code>loader</code>以及<code>plugins</code>在这里</td>
</tr>
<tr>
<td style="text-align:center"><code>pro.js</code></td>
<td style="text-align:left">生产环境的特殊配置（代码压缩、资源上传）</td>
</tr>
<tr>
<td style="text-align:center"><code>dev.js</code></td>
<td style="text-align:left">开发环境的特殊配置（<code>source-map</code>）</td>
</tr>
</tbody>
</table>
<p><code>dll</code>是一个很早之前的套路了，大概需要修改这么几处：</p>
<ol>
<li>创建一个单独的<code>webpack</code>文件，用于生成<code>dll</code>文件</li>
<li>在普通的<code>webpack</code>文件中进行引用生成的<code>dll</code>文件</li>
</ol>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// dll.js</span>
<span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 需要提前打包的库</span>
    vendors<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">'react'</span><span class="token punctuation">,</span>
      <span class="token string">'react-dom'</span><span class="token punctuation">,</span>
      <span class="token string">'react-router-dom'</span><span class="token punctuation">,</span>
      <span class="token string">'babel-polyfill'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">'vendors.dll.js'</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../client-dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 输出时不要少了这个option</span>
    library<span class="token punctuation">:</span> <span class="token string">'vendors_lib'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      context<span class="token punctuation">:</span> __dirname<span class="token punctuation">,</span>
      <span class="token comment" spellcheck="true">// 向外抛出的`vendors.dll.js`代码的具体映射，引用`dll`文件的时候通过它来做映射关系的</span>
      path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../dist/vendors-manifest.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">'vendors_lib'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// base.js</span>
<span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      context<span class="token punctuation">:</span> __dirname<span class="token punctuation">,</span>
      manifest<span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../dist/vendors-manifest.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样在<code>watch</code>文件时，打包就会跳过<code>verdors</code>中存在的那些包了。<br><strong>有一点要注意的，如果最终需要上传这些静态资源，记得连带着<code>verdors.dll.js</code>一并上传</strong>  </p>
<p>在本地开发时，<code>vendors</code>文件并不会自动注入到<code>html</code>模版中去，所以我们有用到了另一个插件，<a href="https://www.npmjs.com/package/add-asset-html-webpack-plugin" target="_blank" rel="noopener">add-asset-html-webpack-plugin</a>。<br>同时在使用中可能还会遇到<code>webpack</code>无限次数的重新打包，这个需要配置<code>ignore</code>来解决-.-：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// dev.js</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> AddAssetHtmlPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'add-asset-html-webpack-plugin'</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">// 将`ejs`模版文件放到目标文件夹，并注入入口`js`文件</span>
    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../index.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      filename<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../views/index.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 将`vendors`文件注入到`ejs`模版中</span>
    <span class="token keyword">new</span> <span class="token class-name">AddAssetHtmlPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      filepath<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../client-dist/vendors.dll.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      includeSourcemap<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 忽略`ejs`和`js`的文件变化，避免`webpack`无限重新打包的问题</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>WatchIgnorePlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token regex">/\.ejs$/</span><span class="token punctuation">,</span>
      <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="TypeScript相关的配置"><a href="#TypeScript相关的配置" class="headerlink" title="TypeScript相关的配置"></a>TypeScript相关的配置</h3><p><code>TS</code>的配置分了两块，一个是<code>webpack</code>的配置，另一个是<code>tsconfig</code>的配置。  </p>
<p>首先是<code>webpack</code>，针对<code>ts</code>、<code>tsx</code>文件我们使用了两个<code>loader</code>：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.tsx?$/</span><span class="token punctuation">,</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">,</span> <span class="token string">'ts-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 一定不要忘记配置ts tsx后缀</span>
    extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'.tsx'</span><span class="token punctuation">,</span> <span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ts-loader</code>用于将<code>TS</code>的一些特性转换为<code>JS</code>兼容的语法，然后执行<code>babel</code>进行处理<code>react/jsx</code>相关的代码，最终生成可执行的<code>JS</code>代码。  </p>
<p>然后是<code>tsconfig</code>的配置，<code>ts-loader</code>的执行是依托于这里的配置的，大致的配置如下：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"compilerOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"module"</span><span class="token punctuation">:</span> <span class="token string">"esnext"</span><span class="token punctuation">,</span>
    <span class="token string">"target"</span><span class="token punctuation">:</span> <span class="token string">"es6"</span><span class="token punctuation">,</span>
    <span class="token string">"allowSyntheticDefaultImports"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// import的相对起始路径</span>
    <span class="token string">"baseUrl"</span><span class="token punctuation">:</span> <span class="token string">"."</span><span class="token punctuation">,</span>
    <span class="token string">"sourceMap"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 构建输出目录，但因为使用了`webpack`，所以这个配置并没有什么卵用</span>
    <span class="token string">"outDir"</span><span class="token punctuation">:</span> <span class="token string">"../client-dist"</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 开启`JSX`模式, </span>
    <span class="token comment" spellcheck="true">// `preserve`的配置让`tsc`不会去处理它，而是使用后续的`babel-loader`进行处理</span>
    <span class="token string">"jsx"</span><span class="token punctuation">:</span> <span class="token string">"preserve"</span><span class="token punctuation">,</span> 
    <span class="token string">"strict"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"moduleResolution"</span><span class="token punctuation">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 开启装饰器的使用</span>
    <span class="token string">"experimentalDecorators"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"emitDecoratorMetadata"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// `vs code`所需要的，在开发时找到对应的路径，真实的引用是在`webpack`中配置的`alias`</span>
    <span class="token string">"paths"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"@Common"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"../src/common"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"@Common/*"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"../src/common/*"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"exclude"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">"node_modules"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ESLint的配置"><a href="#ESLint的配置" class="headerlink" title="ESLint的配置"></a>ESLint的配置</h3><p>最近这段时间，我们团队基于<code>airbnb</code>的<code>ESLint</code>规则进行了一些自定义，创建了自家的<a href="https://www.npmjs.com/package/eslint-config-blued" target="_blank" rel="noopener">eslint-config-blued</a><br>同时还存在了<a href="https://www.npmjs.com/package/eslint-config-blued-react" target="_blank" rel="noopener">react</a>和<a href="https://www.npmjs.com/package/eslint-config-blued-typescript" target="_blank" rel="noopener">typescript</a>的两个衍生版本。  </p>
<p>关于<code>ESLint</code>的配置文件<code>.eslintrc</code>，在本项目中存在两份。一个是根目录的<code>blued-typescript</code>，另一个是<code>client-src</code>下的<code>blued-react</code> + <code>blued-typescript</code>。<br>因为根目录的更多用于<code>node</code>项目，所以没必要把<code>react</code>什么的依赖也装进来。</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># .eslintrc</span>
<span class="token key atrule">extends</span><span class="token punctuation">:</span> blued<span class="token punctuation">-</span>typescript

<span class="token comment" spellcheck="true"># client-src/.eslintrc</span>
<span class="token key atrule">extends</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> blued<span class="token punctuation">-</span>react
  <span class="token punctuation">-</span> blued<span class="token punctuation">-</span>typescript
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>一个需要注意的小细节</strong><br>因为我们的<code>react</code>与<code>typescript</code>实现版本中都用到了<code>parser</code>。<br><code>react</code>使用的是<a href="https://www.npmjs.com/package/babel-eslint" target="_blank" rel="noopener">babel-eslint</a>，<code>typescript</code>使用的是<a href="https://www.npmjs.com/package/typescript-eslint-parser" target="_blank" rel="noopener">typescript-eslint-parser</a>。<br>但是<code>parser</code>只能有一个，从<code>option</code>的命名中就可以看出<code>extends</code>、<code>plugins</code>、<code>rules</code>，到了<code>parser</code>就没有复数了。<br>所以这两个插件在<code>extends</code>中的顺序就变得很关键，<code>babel</code>现在并不能理解<code>TS</code>的语法，但好像<code>babel</code>开发者有支持<code>TS</code>的<a href="https://github.com/babel/babel-eslint/issues/505" target="_blank" rel="noopener">意愿</a>。<br>但就目前来说，一定要保证<code>react</code>在前，<code>typescript</code>在后，这样<code>parser</code>才会使用<code>typescript-eslint-parser</code>来进行覆盖。  </p>
<h3 id="node层的修改"><a href="#node层的修改" class="headerlink" title="node层的修改"></a>node层的修改</h3><p>除了上边提到的两端公用代码以外，还需要添加一个<code>controller</code>用于吐页面，因为使用的是<code>routing-controllers</code>这个库，渲染一个静态页面被封装的非常棒，仅仅需要修改两个页面，一个用于设置<code>render</code>模版的根目录，另一个用来设置要吐出来的模版名称：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// controller/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Get<span class="token punctuation">,</span>
  Controller<span class="token punctuation">,</span>
  Render<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'routing-controllers'</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  @<span class="token function">Render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 指定一个模版的名字</span>
  <span class="token keyword">async</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 渲染页面时的一些变量</span>
    <span class="token comment" spellcheck="true">// 类似之前的 ctx.state = XXX</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">'First TypeScript React App'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// app.ts</span>
<span class="token keyword">import</span> koaViews <span class="token keyword">from</span> <span class="token string">'koa-views'</span>

<span class="token comment" spellcheck="true">// 添加模版所在的目录</span>
<span class="token comment" spellcheck="true">// 以及使用的渲染引擎、文件后缀</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaViews</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../views'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    ext<span class="token punctuation">:</span> <span class="token string">'ejs'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  extension<span class="token punctuation">:</span> <span class="token string">'ejs'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>如果是多个页面，那就创建多个用来<code>Render</code>的<code>ts</code>文件就好了</em>  </p>
<h4 id="深坑，注意"><a href="#深坑，注意" class="headerlink" title="深坑，注意"></a>深坑，注意</h4><p>目前的<code>routing-controller</code>对于<code>Koa</code>的支持还不是很好，（原作者对<code>Koa</code>并不是很了解，导致<code>Render</code>对应的接口被请求一次以后，后续所有的其他的接口都会直接返回该模版文件，原因是在负责模版渲染的<code>URL</code>触发时，本应返回数据，但是目前的处理却是添加了一个中间件到<code>Koa</code>中，所以任何请求都会将该模版文件作为数据来返回）所以<code>@Render</code>并不能适用于<code>Koa</code>驱动。<br>不过我已经提交了<a href="https://github.com/typestack/routing-controllers/pull/434" target="_blank" rel="noopener">PR</a>了，跑通了测试用例，坐等被合并代码，但是这是一个临时的修改方案，涉及到这个库针对外部中间件注册的顺序问题，所以对于<code>app.ts</code>还要有额外的修改才能够实现。</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// app.ts 的修改</span>
<span class="token keyword">import</span> <span class="token string">'reflect-metadata'</span>
<span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">'koa'</span>
<span class="token keyword">import</span> koaViews <span class="token keyword">from</span> <span class="token string">'koa-views'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useKoaServer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'routing-controllers'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> distPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config'</span>

<span class="token comment" spellcheck="true">// 手动创建koa实例，然后添加`render`的中间件，确保`ctx.render`方法会在请求的头部就被添加进去</span>
<span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

koa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaViews</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../views'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    ext<span class="token punctuation">:</span> <span class="token string">'ejs'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  extension<span class="token punctuation">:</span> <span class="token string">'ejs'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 使用`useKoaServer`而不是`createKoaServer`</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">useKoaServer</span><span class="token punctuation">(</span>koa<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/controllers/**/*{.js,.ts}`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 后续的逻辑就都一样了</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> app
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然，这个是新版发出以后的逻辑了，基于现有的结构也可以绕过去，但是就不能使用<code>@Render</code>装饰器了，抛开<code>koa-views</code>直接使用内部的<a href="https://github.com/tj/consolidate.js" target="_blank" rel="noopener">consolidate</a>：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// controller/index.ts</span>
<span class="token comment" spellcheck="true">// 这个修改不需要改动`app.ts`，可以直接使用`createKoaServer`</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Get<span class="token punctuation">,</span>
  Controller<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'routing-controllers'</span>
<span class="token keyword">import</span> cons <span class="token keyword">from</span> <span class="token string">'consolidate'</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 直接在接口返回时获取模版渲染后的数据</span>
    <span class="token keyword">return</span> cons<span class="token punctuation">.</span><span class="token function">ejs</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../views/index.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">'Example For TypeScript React App'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>目前的示例代码采用的上边的方案</em></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>至此，一个完整的TS前后端项目架构就已经搭建完成了（剩下的任务就是往骨架里边填代码了）。<br>我已经更新了之前的<a href="https://github.com/Jiasm/typescript-example" target="_blank" rel="noopener">typescript-exmaple</a>  在里边添加了本次重构所使用的一些前端<code>TS</code>+<code>React</code>的示例，还包括针对<code>@Render</code>的一些兼容。  </p>
<p><code>TypeScript</code>是一个很棒的想法，解决了N多<code>javaScript</code>种令人诟病的问题。<br>使用静态语言来进行开发不仅能够提高开发的效率，同时还能降低错误出现的几率。<br>结合着强大的<code>vs code</code>，Enjoy it.  </p>
<p>如果在使用<code>TS</code>的过程中有什么问题、或者有什么更好的想法，欢迎来沟通讨论。  </p>

</div>

<section class="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
<script>
  var disqus_shortname = 'jiashunming';
  
  var disqus_url = 'http://jiasm.github.io/2018/08/26/TypeScript在react项目中的实践/';
  
  var disqus_config = function () {
    this.page.url = location.href
    this.page.identifier = '045e3c30-a907-11e8-b31a-b7afa1b30f1e'
    this.page.title = document.querySelector('h1').innerText
  };
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.setAttribute('data-timestamp', +new Date());
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script>
  // I'm not sure your browser supports `es6`
  window.addEventListener('load', function () {
    [].concat(Array.from(document.querySelectorAll('code')), Array.from(document.querySelectorAll('pre'))).filter(function (item) {return item.className.indexOf('language') >= 0}).forEach(function (tag) { tag.classList.add('line-numbers') })
    Prism.highlightAll()

    let scrollY = window.scrollY
    let headersList = Array.from(document.querySelector('#post-content').querySelectorAll('h1,h2,h3,h4,h5,h6')).map(function (item) {
      let rect = item.getBoundingClientRect()
      let anchorTag = document.querySelector(`a.toc-link[href="#${item.id}"]`)

      if (!anchorTag) return
      return {
        top: scrollY + rect.top - rect.height,
        tag: item,
        anchorTag: anchorTag
      }
    }).filter(function (item) { return item })

    window.addEventListener('scroll', debounce(scrollHandler, 200))
    scrollHandler()

    function scrollHandler () {
      let scrollY = window.scrollY
      let minInfo = null

      for (let item of headersList) {
        if (!minInfo) {
          minInfo = item
          continue
        }

        if ((scrollY - item.top) >= 0 && (scrollY - minInfo.top) > (scrollY - item.top)) {
          minInfo = item
        }
      }

      if (minInfo) {
        headersList.forEach(function (item) {
          item.anchorTag && item.anchorTag.classList.remove('selected')
        })
        minInfo.anchorTag.classList.add('selected')
      }
    }

    function debounce (func, delay) {
      let debounceIdentify = 0
      return function () {
        debounceIdentify && clearTimeout(debounceIdentify)
        debounceIdentify = setTimeout(function () {
          debounceIdentify = 0
          func.apply(this, arguments)
        }, delay)
      }
    }
  })
</script>

        </main>
        <a href="#" class="goto-top">
          <i class="fa fa-chevron-up"></i>
        </a>
    </div>
    <footer class="footer">
  <div class="footer-content">
    <div class="footer-info" class="inner">
      <p class="copyright">&copy; 2023 ShunMing Jia<br></p>
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      theme by <a href="https://github.com/Jiasm/hexo-theme-sheet" target="_blank">Sheet</a>
    </div>
    <ul class="contact-info">
      
        <a class="contact-link" href="https://github.com/jiasm" target="_blank"><i class="fa fa-github"></i></a>
      
      
        <a class="contact-link" href="https://weibo.com/jarvis1996" target="_blank"><i class="fa fa-weibo"></i></a>
      
      
        <a class="contact-link" href="https://twitter.com/jiashm" target="_blank"><i class="fa fa-twitter"></i></a>
      
      
        <a class="contact-link" href="https://www.facebook.com/jiashunming" target="_blank"><i class="fa fa-facebook"></i></a>
      
      
        <a class="contact-link" href="mailto:jiashunming@outlook.com" target="_blank"><i class="fa fa-envelope"></i></a>
      
    </ul>
  </div>
</footer>

  <!-- 使用 DISQUS js 代码 -->
  <script id="dsq-count-scr" src="//jiashunming.disqus.com/count.js" async="async"></script>



      <script>
      function footerHandler () {
        if (!window.screen || !document.body) return
        var hasComments = document.querySelector('.comments')
        if ((window.screen.availHeight - (hasComments ? 350 : 0)) > document.body.clientHeight) {
          document.body.classList.add('fixed')
        } else {
          document.body.classList.remove('fixed')
        }
      }
      footerHandler()
      window.addEventListener('resize', footerHandler)
    </script>
  </body>
  <script>
    var pathname = new URL(location.href).pathname.replace(/\/$/, '')

    switch (pathname) {
      case '/about':
        document.querySelector('.menu-item-about').classList.add('active')
        break
      case '/contact':
        document.querySelector('.menu-item-contact').classList.add('active')
        break
      case '/links':
        document.querySelector('.menu-item-friends').classList.add('active')
        break
      default:
        document.querySelector('.menu-item-home').classList.add('active')
    }
  </script>
  
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f1f7cb8bfb6de7f6a6277fee35703d98";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    

</html>