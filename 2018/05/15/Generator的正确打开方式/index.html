<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  
  
  
  <title>Generator的正确打开方式 - Jarvis&#39;s Blog</title>
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/prism-coy.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head>


  <body class="fixed">
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">Jarvis&#39;s Blog</a>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link menu-item-home">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link menu-item-about">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/contact" class="menu-item-link menu-item-contact">Contact</a>
        </li>
      
        <li class="menu-item">
          <a href="/links" class="menu-item-link menu-item-friends">Friends</a>
        </li>
      
        <li class="menu-item">
          <a href="https://github.com/jiasm" class="menu-item-link menu-item-github">Github</a>
        </li>
      
    </ul>
  </nav>
</header>

        <main class="main">
          
  <input type="checkbox" id="toggle-toc" class="toggle-toc-right" />
  <div class="toc-toggle toc-toggle-right">
    <label for="toggle-toc">
      <i class="fa fa-list-ol"></i>
    </label>
    <div class="toc-wrap toc-wrap-right">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Generator的语法"><span class="toc-number">1.</span> <span class="toc-text">Generator的语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#generator的初始化与复用"><span class="toc-number">1.1.</span> <span class="toc-text">generator的初始化与复用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-next"><span class="toc-number">1.2.</span> <span class="toc-text">Method: next()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#作为迭代器使用"><span class="toc-number">1.3.</span> <span class="toc-text">作为迭代器使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-return"><span class="toc-number">1.4.</span> <span class="toc-text">Method: return()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-throw"><span class="toc-number">1.5.</span> <span class="toc-text">Method: throw()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Yield的语法"><span class="toc-number">2.</span> <span class="toc-text">Yield的语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#而yield的表现则不一样"><span class="toc-number">2.1.</span> <span class="toc-text">而yield的表现则不一样</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yield"><span class="toc-number">2.2.</span> <span class="toc-text">yield*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yield的返回值"><span class="toc-number">2.3.</span> <span class="toc-text">yield的返回值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一些实际的使用场景"><span class="toc-number">3.</span> <span class="toc-text">一些实际的使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一个简单的随机数生成"><span class="toc-number">3.1.</span> <span class="toc-text">一个简单的随机数生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代替一些递归的操作"><span class="toc-number">3.2.</span> <span class="toc-text">代替一些递归的操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#与async-await的结合"><span class="toc-number">4.</span> <span class="toc-text">与async/await的结合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小记"><span class="toc-number">5.</span> <span class="toc-text">小记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol>
    </div>
  </div>
  <label class="mask" for="toggle-toc"></label>

<div id="post-content">
  <h1>Generator的正确打开方式</h1>
  <blockquote>
<p>前两年大量的在写<code>Generator</code>+<code>co</code>，用它来写一些类似同步的代码<br>但实际上，<code>Generator</code>并不是被造出来干这个使的，不然也就不会有后来的<code>async</code>、<code>await</code>了<br><code>Generator</code>是一个可以被暂停的函数，并且何时恢复，由调用方决定<br>希望本文可以帮助你理解<code>Generator</code>究竟是什么，以及怎么用  </p>
</blockquote>
<a id="more"></a>
<p>放一张图来表示我对<code>Generator</code>的理解：<br><img src="/images/understanding-generators/banner.jpeg" alt=""><br><em>一个咖啡机，虽说我并不喝咖啡，可惜找不到造王老吉的机器-.-</em></p>
<p>我所理解的<del>Generator</del>咖啡机大概就是这么的一个样子的：</p>
<ol>
<li>首先，我们往机器里边放一些咖啡豆</li>
<li>等我们想喝咖啡的时候，就可以按开关(<code>gen.next()</code>)，机器开始磨咖啡豆、煮咖啡、接下来就得到咖啡了</li>
<li>等接满了一杯咖啡后，阀门就会自动关闭(<code>yield</code>)</li>
<li>如果你一开始往机器里边放的咖啡豆很多的话，此时，机器里边还是会有一些剩余的，下次再想喝还可以继续按开关，执行（磨豆、煮咖啡、接咖啡）这一套操作</li>
</ol>
<p>拿<code>Generator</code>将上述咖啡机实现一下：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> coffeeMachineGenerator <span class="token punctuation">(</span>beans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">cookCoffee</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>beans<span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// 煮咖啡</span>
  <span class="token keyword">function</span> cookCoffee <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cooking'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token string">'Here you are'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 往咖啡机放咖啡豆</span>
<span class="token keyword">let</span> coffeeMachine <span class="token operator">=</span> <span class="token function">coffeeMachineGenerator</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 我想喝咖啡了</span>
coffeeMachine<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 我在3秒后还会喝咖啡</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  coffeeMachine<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">1e3</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码运行后，我们首先会得到一条<code>cooking</code>的<code>log</code>，<br>然后在<code>3s</code>后会再次得到一条<code>log</code>。  </p>
<p>这就解释了<code>Generator</code>是什么：<br>一个可以暂停的迭代器<br>调用<code>next</code>来获取数据（<em>我们自己来决定是否何时煮咖啡</em>）<br>在遇到<code>yield</code>以后函数的执行就会停止（<em>接满了一杯，阀门关闭</em>）<br>我们来决定何时运行剩余的代码<code>next</code>（<em>什么时候想喝了再去煮</em>）  </p>
<p><strong>这是<code>Generator</code>中最重要的特性，我们只有在真正需要的时候才获取下一个值，而不是一次性获取所有的值</strong></p>
<h2 id="Generator的语法"><a href="#Generator的语法" class="headerlink" title="Generator的语法"></a>Generator的语法</h2><p>声明<code>Generator</code>函数有很多种途径，最重要的一点就是，在<code>function</code>关键字后添加一个<code>*</code></p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> generator <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span><span class="token operator">*</span> generator <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token operator">*</span>generator <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">*</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token keyword">function</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 错误的示例</span>
<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者，因为是一个函数，也可以作为一个对象的属性来存在：  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">*</span><span class="token function">generator2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">*</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="generator的初始化与复用"><a href="#generator的初始化与复用" class="headerlink" title="generator的初始化与复用"></a>generator的初始化与复用</h3><p>一个<code>Generator</code>函数通过调用两次方法，将会生成两个完全独立的<code>状态机</code><br>所以，保存当前的<code>Generator</code>对象很重要：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> generator <span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'unknown'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token template-string"><span class="token string">`Your name: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> gen1 <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> gen2 <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token string">'Niko Bellic'</span><span class="token punctuation">)</span>

gen1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// { value: Your name: unknown    , done: false}</span>
gen2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// { value: Your name: Niko Bellic, done: false}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Method-next"><a href="#Method-next" class="headerlink" title="Method: next()"></a>Method: next()</h3><p>最常用的<code>next()</code>方法，无论何时调用它，都会得到下一次输出的返回对象（在代码执行完后的调用将会始终返回<code>{value: undefined, done: true}</code>）。  </p>
<p><code>next</code>总会返回一个对象，包含两个属性值：<br><code>value</code>：<code>yield</code>关键字后边表达式的值<br><code>done</code> ：如果已经没有<code>yield</code>关键字了，则会返回<code>true</code> .</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> generator <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">5</span>
  <span class="token keyword">return</span> <span class="token number">6</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 5, done: false}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 6, done: true}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: undefined, done: true}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: undefined, done: true} -- 后续再调用也都会是这个结果</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="作为迭代器使用"><a href="#作为迭代器使用" class="headerlink" title="作为迭代器使用"></a>作为迭代器使用</h3><p><code>Generator</code>函数是一个可迭代的，所以，我们可以直接通过<code>for of</code>来使用它。</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> generator <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">yield</span> <span class="token number">2</span>
  <span class="token keyword">return</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  item
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 1</span>
<span class="token comment" spellcheck="true">// 2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em><code>return</code>不参与迭代</em><br><em>迭代会执行所有的<code>yield</code>，也就是说，在迭代后的<code>Generator</code>对象将不会再返回任何有效的值</em></p>
<h3 id="Method-return"><a href="#Method-return" class="headerlink" title="Method: return()"></a>Method: return()</h3><p>我们可以在迭代器对象上直接调用<code>return()</code>，来终止后续的代码执行。<br>在<code>return</code>后的所有<code>next()</code>调用都将返回<code>{value: undefined, done: true}</code></p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> generator <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">yield</span> <span class="token number">2</span>
  <span class="token keyword">yield</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

gen<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">// {value: undefined, done: true}</span>
gen<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">'hi'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: "hi", done: true}</span>
gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">// {value: undefined, done: true}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Method-throw"><a href="#Method-throw" class="headerlink" title="Method: throw()"></a>Method: throw()</h3><p>在调用<code>throw()</code>后同样会终止所有的<code>yield</code>执行，同时会抛出一个异常，需要通过<code>try-catch</code>来接收：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> generator <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">yield</span> <span class="token number">2</span>
  <span class="token keyword">yield</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

gen<span class="token punctuation">.</span><span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token string">'error text'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Error: error text</span>
gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token comment" spellcheck="true">// {value: undefined, done: true}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Yield的语法"><a href="#Yield的语法" class="headerlink" title="Yield的语法"></a>Yield的语法</h2><p><code>yield</code>的语法有点像<code>return</code>，但是，<code>return</code>是在函数调用结束后返回结果的<br>并且在调用<code>return</code>之后不会执行其他任何的操作</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> method <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">5</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b
  <span class="token comment" spellcheck="true">// 下边的两句代码永远不会执行</span>
  b <span class="token operator">=</span> <span class="token number">6</span>
  <span class="token keyword">return</span> a <span class="token operator">*</span> b
<span class="token punctuation">}</span>

<span class="token function">method</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 11</span>
<span class="token function">method</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 11</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="而yield的表现则不一样"><a href="#而yield的表现则不一样" class="headerlink" title="而yield的表现则不一样"></a>而yield的表现则不一样</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">yieldMethod</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">5</span>
  <span class="token keyword">yield</span> a <span class="token operator">+</span> b
  <span class="token comment" spellcheck="true">// 在执行第二次`next`时，下边两行则会执行</span>
  b <span class="token operator">=</span> <span class="token number">6</span>
  <span class="token keyword">return</span> a <span class="token operator">*</span> b
<span class="token punctuation">}</span>

<span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">yieldMethod</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 11</span>
gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 36</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="yield"><a href="#yield" class="headerlink" title="yield*"></a>yield*</h3><p><code>yield*</code>用来将一个<code>Generator</code>放到另一个<code>Generator</code>函数中执行。<br>有点像<code>[...]</code>的功能：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> gen1 <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">2</span>
  <span class="token keyword">yield</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span> gen2 <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">yield</span> <span class="token operator">*</span> <span class="token function">gen1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token number">4</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> gen <span class="token operator">=</span> <span class="token function">gen2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 1</span>
gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 2</span>
gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 3</span>
gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 4</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="yield的返回值"><a href="#yield的返回值" class="headerlink" title="yield的返回值"></a>yield的返回值</h3><p><code>yield</code>是可以接收返回值的，返回值可以在后续的代码被使用<br><em>一个诡异的写法</em></p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> generator <span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token keyword">yield</span> num
<span class="token punctuation">}</span>

<span class="token keyword">let</span> gen <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// {value: 1, done: false}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 2, done: false}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 3, done: true }</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们在调用第一次<code>next</code>时候，代码执行到了<code>yield num</code>，此时返回<code>num</code><br>然后我们再调用<code>next(2)</code>，代码执行的是<code>yield (yield num)</code>，而其中返回的值就是我们在<code>next</code>中传入的参数了，作为<code>yield num</code>的返回值存在。<br>以及最后的<code>next(3)</code>，执行的是这部分代码<code>return (yield (yield num))</code>，第二次<code>yield</code>表达式的返回值。  </p>
<h2 id="一些实际的使用场景"><a href="#一些实际的使用场景" class="headerlink" title="一些实际的使用场景"></a>一些实际的使用场景</h2><p>上边的所有示例都是建立在已知次数的<code>Generator</code>函数上的，但如果你需要一个未知次数的<code>Generator</code>，仅需要创建一个无限循环就够了。  </p>
<h3 id="一个简单的随机数生成"><a href="#一个简单的随机数生成" class="headerlink" title="一个简单的随机数生成"></a>一个简单的随机数生成</h3><p>比如我们将实现一个随机数的获取：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> randomGenerator <span class="token punctuation">(</span><span class="token operator">...</span>randoms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> len <span class="token operator">=</span> randoms<span class="token punctuation">.</span>length
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> randoms<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> randomeGen <span class="token operator">=</span> <span class="token function">randomGenerator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

randomeGen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 返回一个随机数</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="代替一些递归的操作"><a href="#代替一些递归的操作" class="headerlink" title="代替一些递归的操作"></a>代替一些递归的操作</h3><p>那个最著名的<em>斐波那契数</em>，基本上都会选择使用递归来实现<br>但是再结合着<code>Generator</code>以后，就可以使用一个无限循环来实现了：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>seed1<span class="token punctuation">,</span> seed2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      seed2 <span class="token operator">=</span> seed2 <span class="token operator">+</span> seed1<span class="token punctuation">;</span>
      seed1 <span class="token operator">=</span> seed2 <span class="token operator">-</span> seed1<span class="token punctuation">;</span>
      <span class="token keyword">return</span> seed2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> fib <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fib<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {value: 1, done: false}</span>
fib<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {value: 2, done: false}</span>
fib<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {value: 3, done: false}</span>
fib<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {value: 5, done: false}</span>
fib<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {value: 8, done: false}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="与async-await的结合"><a href="#与async-await的结合" class="headerlink" title="与async/await的结合"></a>与async/await的结合</h2><blockquote>
<p>再次重申，我个人不认为async/await是Generator的语法糖。。  </p>
</blockquote>
<p>如果是写前端的童鞋，基本上都会遇到处理分页加载数据的时候<br>如果结合着<code>Generator</code>+<code>async</code>、<code>await</code>，我们可以这样实现：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span> loadDataGenerator <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token number">1</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token keyword">await</span> <span class="token function">ajax</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> page
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">++</span>page
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 使用setTimeout模拟异步请求</span>
<span class="token keyword">function</span> ajax <span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> page <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`get page: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> loadData <span class="token operator">=</span> <span class="token function">loadDataGenerator</span><span class="token punctuation">(</span><span class="token string">'get-data-url'</span><span class="token punctuation">)</span>

<span class="token keyword">await</span> loadData<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> loadData<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// force load page 1</span>
<span class="token keyword">await</span> loadData<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> loadData<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// get page: 1</span>
<span class="token comment" spellcheck="true">// get page: 2</span>
<span class="token comment" spellcheck="true">// get page: 1</span>
<span class="token comment" spellcheck="true">// get page: 2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样我们可以在简单的几行代码中实现一个分页控制函数了。<br>如果想要从加载特定的页码，直接将<code>page</code>传入<code>next</code>即可。</p>
<h2 id="小记"><a href="#小记" class="headerlink" title="小记"></a>小记</h2><p><code>Generator</code>还有更多的使用方式，（实现异步流程控制、按需进行数据读取）<br>个人认为，<code>Generator</code>的优势在于代码的惰性执行，<code>Generator</code>所实现的事情，我们不使用它也可以做到，只是使用<code>Generator</code>后，能够让代码的可读性变得更好、流程变得更清晰、更专注于逻辑的实现。</p>
<blockquote>
<p>如果有什么不懂的地方 or 文章中一些的错误，欢迎指出</p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://medium.com/@hidace/javascript-es6-generators-part-i-understanding-generators-93dea22bf1b" target="_blank" rel="noopener">Javascript (ES6) Generators — Part I: Understanding Generators</a></li>
<li><a href="https://codeburst.io/what-are-javascript-generators-and-how-to-use-them-c6f2713fd12e" target="_blank" rel="noopener">What are JavaScript Generators and how to use them</a></li>
</ol>
<p><a href="https://github.com/Jiasm/notebook/tree/master/blog-storage/how-to-use-generator" target="_blank" rel="noopener">文章示例代码</a></p>

</div>

<section class="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
<script>
  var disqus_shortname = 'jiashunming';
  
  var disqus_url = 'http://jiasm.github.io/2018/05/15/Generator的正确打开方式/';
  
  var disqus_config = function () {
    this.page.url = location.href
    this.page.identifier = '8ef40710-582d-11e8-ad45-11152b6d83f2'
    this.page.title = document.querySelector('h1').innerText
  };
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.setAttribute('data-timestamp', +new Date());
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script>
  // I'm not sure your browser supports `es6`
  window.addEventListener('load', function () {
    [].concat(Array.from(document.querySelectorAll('code')), Array.from(document.querySelectorAll('pre'))).filter(function (item) {return item.className.indexOf('language') >= 0}).forEach(function (tag) { tag.classList.add('line-numbers') })
    Prism.highlightAll()

    let scrollY = window.scrollY
    let headersList = Array.from(document.querySelector('#post-content').querySelectorAll('h1,h2,h3,h4,h5,h6')).map(function (item) {
      let rect = item.getBoundingClientRect()
      let anchorTag = document.querySelector(`a.toc-link[href="#${item.id}"]`)

      if (!anchorTag) return
      return {
        top: scrollY + rect.top - rect.height,
        tag: item,
        anchorTag: anchorTag
      }
    }).filter(function (item) { return item })

    window.addEventListener('scroll', debounce(scrollHandler, 200))
    scrollHandler()

    function scrollHandler () {
      let scrollY = window.scrollY
      let minInfo = null

      for (let item of headersList) {
        if (!minInfo) {
          minInfo = item
          continue
        }

        if ((scrollY - item.top) >= 0 && (scrollY - minInfo.top) > (scrollY - item.top)) {
          minInfo = item
        }
      }

      if (minInfo) {
        headersList.forEach(function (item) {
          item.anchorTag && item.anchorTag.classList.remove('selected')
        })
        minInfo.anchorTag.classList.add('selected')
      }
    }

    function debounce (func, delay) {
      let debounceIdentify = 0
      return function () {
        debounceIdentify && clearTimeout(debounceIdentify)
        debounceIdentify = setTimeout(function () {
          debounceIdentify = 0
          func.apply(this, arguments)
        }, delay)
      }
    }
  })
</script>

        </main>
        <a href="#" class="goto-top">
          <i class="fa fa-chevron-up"></i>
        </a>
    </div>
    <footer class="footer">
  <div class="footer-content">
    <div class="footer-info" class="inner">
      <p class="copyright">&copy; 2023 ShunMing Jia<br></p>
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      theme by <a href="https://github.com/Jiasm/hexo-theme-sheet" target="_blank">Sheet</a>
    </div>
    <ul class="contact-info">
      
        <a class="contact-link" href="https://github.com/jiasm" target="_blank"><i class="fa fa-github"></i></a>
      
      
        <a class="contact-link" href="https://weibo.com/jarvis1996" target="_blank"><i class="fa fa-weibo"></i></a>
      
      
        <a class="contact-link" href="https://twitter.com/jiashm" target="_blank"><i class="fa fa-twitter"></i></a>
      
      
        <a class="contact-link" href="https://www.facebook.com/jiashunming" target="_blank"><i class="fa fa-facebook"></i></a>
      
      
        <a class="contact-link" href="mailto:jiashunming@outlook.com" target="_blank"><i class="fa fa-envelope"></i></a>
      
    </ul>
  </div>
</footer>

  <!-- 使用 DISQUS js 代码 -->
  <script id="dsq-count-scr" src="//jiashunming.disqus.com/count.js" async="async"></script>



      <script>
      function footerHandler () {
        if (!window.screen || !document.body) return
        var hasComments = document.querySelector('.comments')
        if ((window.screen.availHeight - (hasComments ? 350 : 0)) > document.body.clientHeight) {
          document.body.classList.add('fixed')
        } else {
          document.body.classList.remove('fixed')
        }
      }
      footerHandler()
      window.addEventListener('resize', footerHandler)
    </script>
  </body>
  <script>
    var pathname = new URL(location.href).pathname.replace(/\/$/, '')

    switch (pathname) {
      case '/about':
        document.querySelector('.menu-item-about').classList.add('active')
        break
      case '/contact':
        document.querySelector('.menu-item-contact').classList.add('active')
        break
      case '/links':
        document.querySelector('.menu-item-friends').classList.add('active')
        break
      default:
        document.querySelector('.menu-item-home').classList.add('active')
    }
  </script>
  
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f1f7cb8bfb6de7f6a6277fee35703d98";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    

</html>